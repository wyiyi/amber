<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录点点滴滴"><title>基于 MyBatis 拦截器机制实现一个敏感数据处理组件 | Amber</title><link rel="stylesheet" type="text/css" href="/amber/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/amber/css/dark.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/amber/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/amber/favicon.ico"><link rel="apple-touch-icon" href="/amber/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/amber/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/amber/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于 MyBatis 拦截器机制实现一个敏感数据处理组件</h1><a id="logo" href="/amber/.">Amber</a><p class="description">一天进步一点</p></div><div id="nav-menu"><a class="current" href="/amber/."><i class="fa fa-home"> Home</i></a><a href="/amber/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/amber/about/"><i class="fa fa-user"> About</i></a><a href="/amber/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于 MyBatis 拦截器机制实现一个敏感数据处理组件</h1><div class="post-meta">2024-02-01<span> | </span><span class="category"><a href="/amber/categories/Technology/">Technology</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3.9k</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 18</span><span class="post-meta-item-text"> Minutes</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Interceptor-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">Interceptor 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Signature-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">Signature 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Interceptor-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.2.</span> <span class="toc-text">Interceptor 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simple-Example"><span class="toc-number">2.3.</span> <span class="toc-text">Simple Example</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">敏感数据处理组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">场景描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">设计思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.</span> <span class="toc-text">参考实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%8B%A6%E6%88%AA%E5%99%A8-DataSensitiveInterceptor"><span class="toc-number">3.3.1.</span> <span class="toc-text">自定义敏感数据处理拦截器 DataSensitiveInterceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB-DataSensitiveConfig"><span class="toc-number">3.3.2.</span> <span class="toc-text">配置类 DataSensitiveConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%8E%A5%E5%8F%A3-DataSensitiveHandler"><span class="toc-number">3.3.3.</span> <span class="toc-text">敏感数据处理接口 DataSensitiveHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.4.</span> <span class="toc-text">内置敏感数据处理实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.5.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">3.5.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p><code>MyBatis</code> 作为一个流行的持久层框架，提供了拦截器 <code>Interceptor</code> 机制，允许开发者在 <code>SQL</code> 执行过程中插入自定义逻辑。本文将深入探讨 <code>MyBatis</code> 拦截器的用法和使用场景，并以处理敏感数据场景为例实现了一个自定义拦截器。</p>
<h1 id="Interceptor-介绍"><a href="#Interceptor-介绍" class="headerlink" title="Interceptor 介绍"></a>Interceptor 介绍</h1><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh_CN/configuration.html#%E6%8F%92%E4%BB%B6%EF%BC%88plugins%EF%BC%89">MyBatis 官网中 Interceptor 的介绍：</a></p>
<blockquote>
<p>MyBatis 允许你在映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括：</p>
<ul>
<li>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li>
<li>ParameterHandler (getParameterObject, setParameters)</li>
<li>ResultSetHandler (handleResultSets, handleOutputParameters)</li>
<li>StatementHandler (prepare, parameterize, batch, update, query)</li>
</ul>
<p>通过 MyBatis 提供的强大机制，使用插件是非常简单的，只需实现 Interceptor 接口，并指定想要拦截的方法签名即可。</p>
</blockquote>
<h2 id="Signature-介绍"><a href="#Signature-介绍" class="headerlink" title="Signature 介绍"></a>Signature 介绍</h2><p>在 <a target="_blank" rel="noopener" href="https://book.douban.com/subject/27074809/">《MyBatis从入门到精通》</a> 一书中，关于拦截器签名 <code>@Signature</code> 注解中可以使用的接口和方法相关描述如下：</p>
<ol>
<li><p><strong>Executor</strong>：</p>
<ul>
<li>update: 当执行 INSERT、UPDATE、DELETE 操作时调用。</li>
<li>query: 在 SELECT 查询方法执行时调用。</li>
<li>flushStatements: 在通过 SqlSession 方法调用 flushStatements 方法或执行的接口方法中带有 @Flush 注解时才被调用。</li>
<li>commit: 在通过 SqlSession 方法调用 commit 方法时被调用。</li>
<li>rollback: 在通过 SqlSession 方法调用 rollback 方法时被调用。</li>
<li>getTransaction: 在通过 SqlSession 方法获取数据库连接时被调用。</li>
<li>close: 在延迟加载获取新的 Executor 后才会被执行。</li>
<li>isClosed: 在延迟加载执行查询方法前被执行。</li>
</ul>
</li>
<li><p><strong>ParameterHandler</strong>：</p>
<ul>
<li>getParameterObject: 在执行存储过程处理出参的时候被调用。</li>
<li>setParameters: 在所有数据库方法设置 SQL 参数时被调用。</li>
</ul>
</li>
<li><p><strong>ResultSetHandler</strong>：</p>
<ul>
<li>handleResultSets: 处理查询结果集。</li>
<li>handleOutputParameters: 使用存储过程处理出参时被调用。</li>
</ul>
</li>
<li><p><strong>StatementHandler</strong>：</p>
<ul>
<li>prepare: 在数据库执行前被调用，优先于当前接口中其他方法而被执行。</li>
<li>parameterize: 在 prepare 方法后执行，用于处理参数信息。</li>
<li>batch: 在全局设置配置 defaultExecutorType=”BATCH” 时执行数据操作才会调用。</li>
<li>update: 用于执行更新类型的 SQL 语句。</li>
<li>query: 用于获取查询返回的结果集。</li>
</ul>
</li>
</ol>
<h2 id="Interceptor-接口"><a href="#Interceptor-接口" class="headerlink" title="Interceptor 接口"></a>Interceptor 接口</h2><p>通过实现 <code>Interceptor</code> 接口并指定想要拦截的方法签名，可以轻松地实现对 SQL 执行过程的拦截。<br><code>Interceptor</code> 接口包含以下方法：（Mybatis-3.5.1 版本）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">plugin</span><span class="params">(Object target)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>intercept(Invocation invocation)</code>: 这个方法用于拦截目标方法并执行自定义逻辑。获取目标方法的参数、方法等信息，并进行处理。</li>
<li><code>plugin(Object target)</code>: 这个方法用于生成一个代理对象。需要判断目标对象是否需要被拦截，如果需要则返回一个代理对象，否则返回 null。</li>
<li><code>setProperties(Properties properties)</code>: 这个方法用于设置属性。获取配置文件中的属性，并进行相应的设置。</li>
</ul>
<p>在 <code>MyBatis</code> 的配置文件中注册自定义 <code>Interceptor</code> 后，框架会在执行相应的操作时自动调用自定义逻辑。</p>
<h2 id="Simple-Example"><a href="#Simple-Example" class="headerlink" title="Simple Example"></a>Simple Example</h2><ol>
<li>创建 <code>ExamplePlugin</code> 类实现 <code>org.apache.ibatis.plugin.Interceptor</code> 接口：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExamplePlugin.java</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">   @Signature(type= Executor.class,</span></span><br><span class="line"><span class="meta">              method = &quot;update&quot;,</span></span><br><span class="line"><span class="meta">              args = &#123;MappedStatement.class,Object.class&#125;),</span></span><br><span class="line"><span class="meta">   @Signature(type = ResultSetHandler.class, </span></span><br><span class="line"><span class="meta">              method = &quot;handleResultSets&quot;, </span></span><br><span class="line"><span class="meta">              args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// implement pre processing if need</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnObject</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">    <span class="comment">// implement post processing if need</span></span><br><span class="line">    <span class="keyword">return</span> returnObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.properties = properties;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Tips</strong>：在 <a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3/blob/mybatis-3.5.2/src/main/java/org/apache/ibatis/plugin/Interceptor.java">Mybatis-3.5.2 版本后 Interceptor</a> 接口中定义的方法已给出了默认实现，如无特殊需求，只需实现 <code>intercept</code> 方法，这是 <code>Java 8</code> 默认方法特性的一种应用，旨在简化接口的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">    <span class="comment">// NOP</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 <code>MyBatis</code> 的配置文件中注册 <code>ExamplePlugin</code>：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- mybatis-config.xml --&gt;</span><br><span class="line">&lt;plugins&gt;</span><br><span class="line">  &lt;plugin interceptor=&quot;org.mybatis.example.ExamplePlugin&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;</span><br><span class="line">  &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure>

<h1 id="敏感数据处理组件"><a href="#敏感数据处理组件" class="headerlink" title="敏感数据处理组件"></a>敏感数据处理组件</h1><h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>在持久化的数据涉及敏感内容时，假设有如下三种场景：</p>
<ol>
<li>为避免拖库造成的数据泄露风险，敏感数据希望以密文形式存储在数据库中，通过系统读取时可以读取到明文；</li>
<li>密码类数据在存储前希望进行不可逆的加密处理，读取时也是使用密文进行对比，无需恢复出明文内容；</li>
<li>展示如手机号等数据时，希望对部分内容进行遮挡，使数据仅保留核对用途。</li>
</ol>
<h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>上面假设的三种场景可以分为数据的 <code>读取</code> 和 <code>写入</code> 两类操作：</p>
<ul>
<li>场景 1 需要在数据写入时加密，读取数据时解密；</li>
<li>场景 2 在数据写入时加密，读取时无需处理；</li>
<li>场景 3 在数据读取时进行遮挡，写入时无需处理。</li>
</ul>
<p><code>MyBatis</code> 的拦截器签名中，可以选择 <code>Executor</code> 的 <code>update</code> 方法拦截 <code>写入</code> 动作，<code>ResultSetHandler</code> 的 <code>handleResultSets</code> 方法拦截 <code>读取</code> 动作。</p>
<p>为满足不同类型的敏感数据处理需求，设计一个 <code>DataSensitiveHandler</code> 接口，接口中包含两个方法：</p>
<ul>
<li><code>encrypt</code>：实现写入数据前要执行的操作</li>
<li><code>decrypt</code>：实现读取数据后（返回数据前）要执行的操作</li>
</ul>
<p>可以注册不同的 <code>DataSensitiveHandler</code> 实现类，并为实体中的属性（表中字段）配置使用哪个实现进行敏感数据的处理。</p>
<p>为了尽可能少地修改原有代码，以统一的配置方式实现属性（字段）和处理类的映射。</p>
<p>具体配置形式参考日志级别配置方式（如：<code>logging.level.com.example.demo.mapper=debug</code>），<br>以 <code>固定前缀</code>.<code>实体package.实体名.属性名</code> = <code>具体处理类唯一标识</code> 进行设置。</p>
<h2 id="参考实现"><a href="#参考实现" class="headerlink" title="参考实现"></a>参考实现</h2><h3 id="自定义敏感数据处理拦截器-DataSensitiveInterceptor"><a href="#自定义敏感数据处理拦截器-DataSensitiveInterceptor" class="headerlink" title="自定义敏感数据处理拦截器 DataSensitiveInterceptor"></a>自定义敏感数据处理拦截器 <code>DataSensitiveInterceptor</code></h3><p>在 <code>intercept</code> 方法中根据配置找到需要处理的属性的处理类（<code>dataSensitiveHandler-</code> 为前缀的 <code>Bean</code>），并根据拦截的写入和读取操作调用对应处理方法，以实现敏感数据处理的要求（如中间部分用*代替、显示密文处理后的结果等）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = ResultSetHandler.class, method = &quot;handleResultSets&quot;, args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSensitiveInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; configs;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取配置文件中需要加密的属性</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> config DataSensitiveConfig</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">DataSensitiveInterceptor</span><span class="params">(DataSensitiveConfig config)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.configs = config.getSensitive();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 通过拦截器处理</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> invocation invocation</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Throwable 异常</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">      <span class="keyword">if</span> (invocation.getTarget() <span class="keyword">instanceof</span> Executor) &#123;</span><br><span class="line">         <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">         <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) object;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!entry.getKey().startsWith(<span class="string">&quot;param&quot;</span>)) &#123;</span><br><span class="line">                  handleEncrypt(entry.getValue());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleEncrypt(object);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (invocation.getTarget() <span class="keyword">instanceof</span> ResultSetHandler) &#123;</span><br><span class="line">         <span class="type">ResultSetHandler</span> <span class="variable">resultSetHandler</span> <span class="operator">=</span> (ResultSetHandler) invocation.getTarget();</span><br><span class="line">         <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> (Statement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">         List&lt;Object&gt; resultList = resultSetHandler.handleResultSets(statement);</span><br><span class="line">         resultList.forEach(<span class="built_in">this</span>::handleDecrypt);</span><br><span class="line">         <span class="keyword">return</span> resultList;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleEncrypt</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">      handleObject(object, <span class="literal">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDecrypt</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">      handleObject(object, <span class="literal">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleObject</span><span class="params">(Object object, <span class="type">boolean</span> encrypt)</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; config : configs.entrySet()) &#123;</span><br><span class="line">         <span class="type">int</span> <span class="variable">lastPoint</span> <span class="operator">=</span> config.getKey().lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">         <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> config.getKey().substring(<span class="number">0</span>, lastPoint);</span><br><span class="line">         <span class="keyword">if</span> (object.getClass().getName().equals(className)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> config.getKey().substring(lastPoint + <span class="number">1</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">handlerName</span> <span class="operator">=</span> config.getValue();</span><br><span class="line">            <span class="type">DataSensitiveHandler</span> <span class="variable">handler</span> <span class="operator">=</span> SpringContextHolder.getBean(<span class="string">&quot;dataSensitiveHandler-&quot;</span> + handlerName);</span><br><span class="line">            <span class="type">BeanWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(object);</span><br><span class="line">            wrapper.setPropertyValue(property,</span><br><span class="line">                    wrapper.getPropertyValue(property) == <span class="literal">null</span> ? <span class="literal">null</span> :</span><br><span class="line">                            encrypt ? handler.encrypt(String.valueOf(wrapper.getPropertyValue(property))) :</span><br><span class="line">                                    handler.decrypt(String.valueOf(wrapper.getPropertyValue(property)))</span><br><span class="line">            );</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置类-DataSensitiveConfig"><a href="#配置类-DataSensitiveConfig" class="headerlink" title="配置类 DataSensitiveConfig"></a>配置类 <code>DataSensitiveConfig</code></h3><p>配置参数以前缀 <code>com.amber.common.sensitive</code> 开头，以 Map 形式存储相关参数配置，其中：</p>
<ul>
<li><code>key</code> 设置为 MyBatis Mapper 实体类全名及要处理敏感数据的属性，如 <code>UserDO</code> 的 <code>phone</code> 属性设置为：<code>com.amber.common.sensitive.mock.entity.UserDO.phone</code></li>
<li><code>value</code> 设置为敏感数据处理类 <code>bean name</code> 的后缀，查找 bean 时加上 <code>dataSensitiveHandler-</code> 前缀组成完整 <code>bean name</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;com.amber.common&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSensitiveConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; sensitive = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getSensitive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sensitive;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="敏感数据处理接口-DataSensitiveHandler"><a href="#敏感数据处理接口-DataSensitiveHandler" class="headerlink" title="敏感数据处理接口 DataSensitiveHandler"></a>敏感数据处理接口 <code>DataSensitiveHandler</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DataSensitiveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 在写入数据时对数据做的处理</span></span><br><span class="line"><span class="comment">    * 默认为不进行任何操作</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str 将要写入的数据</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 实际写入的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">default</span> String <span class="title function_">encrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 在读取数据时对数据做的处理</span></span><br><span class="line"><span class="comment">    * 默认为不进行任何操作</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str 实际读到的数据</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 返回给调用者的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">default</span> String <span class="title function_">decrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内置敏感数据处理实现"><a href="#内置敏感数据处理实现" class="headerlink" title="内置敏感数据处理实现"></a>内置敏感数据处理实现</h3><p>为每类场景提供一个内置敏感数据处理实现：</p>
<ul>
<li><code>abb</code>：对字符串中间部分使用 <code>*</code> 遮挡，仅在读取数据时执行操作</li>
<li><code>md5</code>：对字符串进行 md5 摘要，仅在写入数据时执行操作</li>
<li><code>sm4hex</code>：使用国密 SM4 算法进行对称加解密，以 16 进制表示加密结果，在写入及读取时均执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 敏感数据处理器：使用 * 遮挡明文中间部分，保留前后内容。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 仅在读取明文数据并返回时，进行遮挡处理；</span></span><br><span class="line"><span class="comment"> * 存入明文数据时，不对存入内容进行变更。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 遮挡方式为：&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 1. 明文长度为 1 时，不遮挡&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 2. 明文长度为 2 时，遮挡第二位&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 3. 明文长度大于 2 时，将明文分成三部分，遮挡中间部分；不能整除时，尽可能使遮挡部分较多&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 遮挡后内容长度与明文保持一致。</span></span><br><span class="line"><span class="comment"> * 如：&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 明文                   | 遮挡后&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;a&#x27;                   | &#x27;a&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;ab&#x27;                  | &#x27;a*&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;abc&#x27;                 | &#x27;a*c&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;abcd&#x27;                | &#x27;a**d&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;13012345678&#x27;         | &#x27;130*****678&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;123456789012345678&#x27;  | &#x27;123456******345678&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#x27;这是一段测试文字&#x27;       | &#x27;这是****文字&#x27;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 注册 bean 使用 ”dataSensitiveHandler-“ 固定前缀，abb 为后缀，意为 abbreviation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;dataSensitiveHandler-abb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSensitiveAbbHandler</span> <span class="keyword">implements</span> <span class="title class_">DataSensitiveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">MASK</span> <span class="operator">=</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 实现解密方法，对字符串中间部分使用 `*` 遮挡</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str str</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">decrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isBlank(str)) &#123;</span><br><span class="line">         <span class="keyword">return</span> str;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> str.length();</span><br><span class="line">      <span class="keyword">switch</span> (len) &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> str.substring(<span class="number">0</span>, <span class="number">1</span>) + MASK;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">            <span class="type">int</span> <span class="variable">oriLen</span> <span class="operator">=</span> len / <span class="number">3</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">maskLen</span> <span class="operator">=</span> len - oriLen * <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> str.substring(<span class="number">0</span>, oriLen) +</span><br><span class="line">                    StringUtils.repeat(MASK, maskLen) +</span><br><span class="line">                    str.substring(oriLen + maskLen);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义处理器注册 bean，”dataSensitiveHandler-“ 为固定前缀</span></span><br><span class="line"><span class="comment"> * 自定义后缀：对字符串进行 md5 摘要，仅在写入数据时执行操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;dataSensitiveHandler-md5&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSensitiveMd5Handler</span> <span class="keyword">implements</span> <span class="title class_">DataSensitiveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义处理器注册 bean，”dataSensitiveHandler-“ 为固定前缀</span></span><br><span class="line"><span class="comment"> * 自定义后缀：sm4 使用国密 SM4 算法进行对称加解密，在写入及读取时均执行</span></span><br><span class="line"><span class="comment"> * 条件注册 Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(name = &#123;&quot;org.bouncycastle.crypto.Digest&quot;, &quot;org.bouncycastle.asn1.gm.GMNamedCurves&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Component(&quot;dataSensitiveHandler-sm4hex&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSensitiveSm4HexHandler</span> <span class="keyword">implements</span> <span class="title class_">DataSensitiveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SymmetricCrypto</span> <span class="variable">SM4</span> <span class="operator">=</span> SmUtil.sm4();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用国密 SM4 算法进行加密</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str 明文</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 密文 16 进制表示</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">encrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> SM4.encryptHex(str);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用国密 SM4 算法进行解密</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str 密文</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 明文</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">decrypt</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> SM4.decryptStr(str, CharsetUtil.CHARSET_UTF_8);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要其他类型的处理类时，注册一个实现了 <code>DataSensitiveHandler</code> 的 bean 即可。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>支持 <code>yml</code> 和 <code>properties</code> 文件格式：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com:</span></span><br><span class="line">  <span class="attr">amber:</span></span><br><span class="line">    <span class="attr">common:</span></span><br><span class="line">      <span class="attr">sensitive:</span></span><br><span class="line">        <span class="attr">com.amber.common.sensitive.mock.entity.UserDO.phone:</span> <span class="string">abb</span></span><br><span class="line">        <span class="attr">com.amber.common.sensitive.mock.entity.UserDO.idCard:</span> <span class="string">sm4hex</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com.amber.common.sensitive.com.amber.common.sensitive.mock.entity.UserDO.password</span>=<span class="string">md5</span></span><br></pre></td></tr></table></figure>

<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><ul>
<li>加密和解密：确保敏感数据在写入数据库时被正确加密，并在从数据库读取时被正确解密。</li>
<li>配置解析：验证配置文件中的敏感字段是否正确地被解析并应用到拦截器中。</li>
<li>不同处理器的应用：测试不同的敏感数据处理器（如 abb、md5、sm4）是否按照预期工作。</li>
<li>非敏感字段的不处理：确保非敏感字段在拦截器中不被错误地处理。</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Sql</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataSensitiveTest</span> <span class="keyword">extends</span> <span class="title class_">BaseApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   UserDAO userDAO</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   RoleDAO roleDAO</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   UserService userService</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   RoleService roleService</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   UserRoleService userRoleService</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   UserHistoryService userHistoryService</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   JdbcTemplate jdbcTemplate</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> <span class="keyword">static</span> <span class="keyword">final</span> MD5_LEN = <span class="number">32</span></span><br><span class="line">   <span class="keyword">def</span> name = <span class="string">&#x27;user name&#x27;</span></span><br><span class="line">   <span class="keyword">def</span> phone = <span class="string">&#x27;12345678901&#x27;</span></span><br><span class="line">   <span class="keyword">def</span> idCard = <span class="string">&#x27;234098uzxcv&#x27;</span></span><br><span class="line">   <span class="keyword">def</span> pwd = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="type">void</span> cruTest() &#123;</span><br><span class="line">      <span class="keyword">def</span> user = testCreate()</span><br><span class="line">      <span class="keyword">def</span> retrievedUser = testRetrieve(user.getId())</span><br><span class="line">      testUpdate(retrievedUser)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testCreate() &#123;</span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select count(*) from userinfo&#x27;</span>, Integer) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      UserDO user = <span class="keyword">new</span> UserDO()</span><br><span class="line">      user.setName(name)</span><br><span class="line">      user.setPhone(phone)</span><br><span class="line">      user.setIdCard(idCard)</span><br><span class="line">      user.setPassword(pwd)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> userDAO.insert(user) == <span class="number">1</span></span><br><span class="line">      <span class="keyword">assert</span> user.getId() &gt; <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="comment">// abb handler</span></span><br><span class="line">      <span class="keyword">assert</span> user.getPhone() == phone</span><br><span class="line">      <span class="comment">// md5 handler</span></span><br><span class="line">      <span class="keyword">assert</span> user.getPassword().length() == MD5_LEN</span><br><span class="line">      <span class="comment">// sm4hex handler</span></span><br><span class="line">      <span class="keyword">assert</span> user.getIdCard() != idCard &amp;&amp; user.getIdCard().length() == getSm4HexLen(idCard)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select count(*) from userinfo&#x27;</span>, Integer) == <span class="number">1</span></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select phone from userinfo&#x27;</span>, String) == phone</span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select password from userinfo&#x27;</span>, String).length() == MD5_LEN</span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select id_card from userinfo&#x27;</span>, String) != <span class="string">&#x27;234098uzxcv&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select id_card from userinfo&#x27;</span>, String).length() == getSm4HexLen(idCard)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> user</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> <span class="type">int</span> getSm4HexLen(String str) &#123;</span><br><span class="line">      <span class="comment">// SM4算法的块大小为16字节</span></span><br><span class="line">      <span class="type">int</span> blockSize = <span class="number">16</span></span><br><span class="line">      str &gt; <span class="string">&#x27;&#x27;</span> ?</span><br><span class="line">              ((int) (str.getBytes(StandardCharsets.UTF_8).length / blockSize) + <span class="number">1</span>) * blockSize * <span class="number">2</span> :</span><br><span class="line">              <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testRetrieve(String userId) &#123;</span><br><span class="line">      UserDO retrievedUser = userDAO.selectById(userId)</span><br><span class="line">      <span class="keyword">assert</span> retrievedUser.getPhone() != phone</span><br><span class="line">      <span class="keyword">assert</span> retrievedUser.getPhone() == <span class="string">&#x27;123*****901&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUser.getIdCard() == idCard</span><br><span class="line">      <span class="keyword">return</span> retrievedUser</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testUpdate(UserDO userToUpdate) &#123;</span><br><span class="line">      <span class="keyword">def</span> newPhone = <span class="string">&#x27;01234567890&#x27;</span></span><br><span class="line">      <span class="keyword">def</span> newIdCard = <span class="string">&#x27;12345678901234567&#x27;</span></span><br><span class="line"></span><br><span class="line">      userToUpdate.setPhone(newPhone)</span><br><span class="line">      userToUpdate.setIdCard(newIdCard)</span><br><span class="line">      userDAO.updateById(userToUpdate)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> userToUpdate.getPhone() == newPhone</span><br><span class="line">      <span class="keyword">assert</span> userToUpdate.getIdCard() != newIdCard</span><br><span class="line">      <span class="keyword">assert</span> userToUpdate.getIdCard().length() == getSm4HexLen(newIdCard)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select phone from userinfo&#x27;</span>, String) == newPhone</span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select id_card from userinfo&#x27;</span>, String) != newIdCard</span><br><span class="line"></span><br><span class="line">      <span class="keyword">def</span> retrievedUser = userDAO.selectById(userToUpdate.getId())</span><br><span class="line">      <span class="keyword">assert</span> retrievedUser.getPhone() == <span class="string">&#x27;012*****890&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUser.getIdCard() == newIdCard</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="type">void</span> batchTest() &#123;</span><br><span class="line">      testBatchInsert()</span><br><span class="line">      List&lt;UserDO&gt; retrievedUsers = testBatchRetrieve()</span><br><span class="line">      testBatchUpdate(retrievedUsers)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testBatchInsert() &#123;</span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select count(*) from userinfo&#x27;</span>, Integer) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      List&lt;UserDO&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;()</span><br><span class="line">      <span class="number">3.</span>times &#123;</span><br><span class="line">         UserDO user = <span class="keyword">new</span> UserDO()</span><br><span class="line">         user.setName(<span class="string">&quot;$&#123;name&#125;$&#123;it+1&#125;&quot;</span>)</span><br><span class="line">         user.setPhone(<span class="string">&quot;$&#123;phone&#125;$&#123;it+1&#125;&quot;</span>)</span><br><span class="line">         user.setPassword(<span class="string">&quot;$&#123;pwd&#125;$&#123;it+1&#125;&quot;</span>)</span><br><span class="line">         user.setIdCard(<span class="string">&quot;$&#123;idCard&#125;$&#123;it+1&#125;&quot;</span>)</span><br><span class="line">         users.add(user)</span><br><span class="line">      &#125;</span><br><span class="line">      userService.saveBatch(users)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&#x27;select count(*) from userinfo&#x27;</span>, Integer) == <span class="number">3</span></span><br><span class="line">      <span class="comment">// sm4hex handler</span></span><br><span class="line">      <span class="keyword">assert</span> users.get(<span class="number">0</span>).getIdCard() != idCard</span><br><span class="line">      <span class="keyword">assert</span> users.get(<span class="number">0</span>).getIdCard().length() == getSm4HexLen(idCard)</span><br><span class="line">      <span class="comment">// abb handler</span></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForList(<span class="string">&#x27;select phone from userinfo&#x27;</span>, String) == [<span class="string">&quot;$&#123;phone&#125;1&quot;</span>, <span class="string">&quot;$&#123;phone&#125;2&quot;</span>, <span class="string">&quot;$&#123;phone&#125;3&quot;</span>]</span><br><span class="line">      <span class="keyword">assert</span> users.get(<span class="number">0</span>).getPhone() == <span class="string">&quot;$&#123;phone&#125;1&quot;</span></span><br><span class="line">      <span class="comment">// sm4hex handler</span></span><br><span class="line">      <span class="keyword">def</span> queriedIdCard = jdbcTemplate.queryForObject(<span class="string">&quot;select id_card from userinfo where user_name=&#x27;$&#123;name&#125;2&#x27;&quot;</span>, String)</span><br><span class="line">      <span class="keyword">assert</span> queriedIdCard != <span class="string">&quot;$&#123;idCard&#125;2&quot;</span></span><br><span class="line">      <span class="keyword">assert</span> queriedIdCard.length() == getSm4HexLen(<span class="string">&quot;$&#123;idCard&#125;2&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testBatchRetrieve() &#123;</span><br><span class="line">      List&lt;UserDO&gt; retrievedUsers = userService.list()</span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers.size() == <span class="number">3</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">0</span>].getPhone() == <span class="string">&#x27;1234****9011&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">1</span>].getPhone() == <span class="string">&#x27;1234****9012&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">2</span>].getPhone() == <span class="string">&#x27;1234****9013&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">0</span>].getIdCard() == <span class="string">&quot;$&#123;idCard&#125;1&quot;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">1</span>].getIdCard() == <span class="string">&quot;$&#123;idCard&#125;2&quot;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">2</span>].getIdCard() == <span class="string">&quot;$&#123;idCard&#125;3&quot;</span></span><br><span class="line">      <span class="keyword">return</span> retrievedUsers</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> testBatchUpdate(List&lt;UserDO&gt; retrievedUsers) &#123;</span><br><span class="line">      List&lt;UserDO&gt; usersToUpdate = <span class="keyword">new</span> ArrayList&lt;UserDO&gt;()</span><br><span class="line">      <span class="keyword">for</span> (UserDO <span class="attr">user :</span> retrievedUsers) &#123;</span><br><span class="line">         user.setPhone(phone.reverse())</span><br><span class="line">         user.setIdCard(idCard.reverse())</span><br><span class="line">         usersToUpdate.add(user)</span><br><span class="line">      &#125;</span><br><span class="line">      userService.updateBatchById(usersToUpdate)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from userinfo where phone = &#x27;$&#123;phone.reverse()&#125;&#x27;&quot;</span>, Integer) == <span class="number">3</span></span><br><span class="line">      <span class="keyword">assert</span> jdbcTemplate.queryForObject(<span class="string">&quot;select id_card from userinfo where user_name=&#x27;$&#123;name&#125;3&#x27;&quot;</span>, String).length() == getSm4HexLen(<span class="string">&quot;$&#123;idCard.reverse()&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">      QueryWrapper&lt;UserDO&gt; wrapper = <span class="keyword">new</span> QueryWrapper()</span><br><span class="line">      wrapper.eq(<span class="string">&#x27;phone&#x27;</span>, phone.reverse())</span><br><span class="line">      retrievedUsers = userService.list(wrapper)</span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers.size() == <span class="number">3</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">0</span>].getPhone() == <span class="string">&#x27;109*****321&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span> retrievedUsers[<span class="number">1</span>].getIdCard() == idCard.reverse()</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整实例可见<a target="_blank" rel="noopener" href="https://github.com/wyiyi/bronze">仓库</a></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>通过 MyBatis 新增或保存实体时，传入的实体在方法调用后，配置为敏感数据的属性会变成应用了敏感处理器 <code>encrypt</code> 方法之后的值</li>
<li>通过 MyBatis 查询实体时，检索出的实体对象中，配置了敏感数据的属性会变成应用了敏感处理器 <code>decrypt</code> 方法之后的值</li>
<li>不通过 MyBatis 操作的数据，不会应用敏感数据处理器处理数据</li>
<li><strong>存入数据库中的数据在执行了敏感处理后将丧失按照处理前的数据进行查询的能力，只能按照处理后的数据进行查询</strong></li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>Title: </span>基于 MyBatis 拦截器机制实现一个敏感数据处理组件</p><p><span>Author: </span>Amber</p><p><span>Date: </span>2024-02-01</p><p><span>Last Update: </span>2025-08-19</p><p><span>Blog Link: </span><a href="/2024/02/01/mybatis-interceptor/">https://wyiyi.github.io/amber/2024/02/01/mybatis-interceptor/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://wyiyi.github.io/amber/2024/02/01/mybatis-interceptor/"></i></span></p><p><span>Copyright Declaration: </span>Copyright © 2022 Amber.</p></div><br><div class="tags"><a href="/amber/tags/Java/"><i class="fa fa-tag"></i>Java</a><a href="/amber/tags/Mybatis/"><i class="fa fa-tag"></i>Mybatis</a></div><div class="post-nav"><a class="pre" href="/amber/2024/03/01/cxy-readme/">程序员的README</a><a class="next" href="/amber/2024/01/01/maven-offline-build/">离线环境下 Maven 编译打包</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '14ea65cf426ef8f465fb',
  clientSecret: '1a449fb0cec00ee09ae36f1f4bd2efc486d7ac8d',
  repo: 'amber',
  owner: 'Amber',
  admin: ['Amber'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://wyiyi.github.io/amber"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/amber/categories/Books/">Books</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/amber/categories/Technology/">Technology</a><span class="category-list-count">32</span></li><li class="category-list-item"><a class="category-list-link" href="/amber/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%8C%E7%94%9F%E6%B4%BB/">小程序，生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/amber/categories/%E5%B7%A5%E4%BD%9C/">工作</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/amber/tags/2022/" style="font-size: 15px;">2022</a> <a href="/amber/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">小程序</a> <a href="/amber/tags/2021/" style="font-size: 15px;">2021</a> <a href="/amber/tags/Postman/" style="font-size: 15px;">Postman</a> <a href="/amber/tags/Apache-Bench/" style="font-size: 15px;">Apache Bench</a> <a href="/amber/tags/Java/" style="font-size: 15px;">Java</a> <a href="/amber/tags/BigDecimal/" style="font-size: 15px;">BigDecimal</a> <a href="/amber/tags/CORS/" style="font-size: 15px;">CORS</a> <a href="/amber/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/amber/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/amber/tags/Wechat/" style="font-size: 15px;">Wechat</a> <a href="/amber/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">公众号</a> <a href="/amber/tags/Git/" style="font-size: 15px;">Git</a> <a href="/amber/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 15px;">反射</a> <a href="/amber/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/amber/tags/Scheduled/" style="font-size: 15px;">Scheduled</a> <a href="/amber/tags/Books/" style="font-size: 15px;">Books</a> <a href="/amber/tags/ResponseEntity/" style="font-size: 15px;">ResponseEntity</a> <a href="/amber/tags/DB/" style="font-size: 15px;">DB</a> <a href="/amber/tags/Servlet%EF%BC%8CFilter/" style="font-size: 15px;">Servlet，Filter</a> <a href="/amber/tags/Servlet%EF%BC%8CFilter%EF%BC%8CInterceptor/" style="font-size: 15px;">Servlet，Filter，Interceptor</a> <a href="/amber/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/amber/tags/Spring-MVC/" style="font-size: 15px;">Spring MVC</a> <a href="/amber/tags/Interceptor/" style="font-size: 15px;">Interceptor</a> <a href="/amber/tags/Go/" style="font-size: 15px;">Go</a> <a href="/amber/tags/JSON-Lines/" style="font-size: 15px;">JSON Lines</a> <a href="/amber/tags/AI/" style="font-size: 15px;">AI</a> <a href="/amber/tags/Java8/" style="font-size: 15px;">Java8</a> <a href="/amber/tags/Lambda/" style="font-size: 15px;">Lambda</a> <a href="/amber/tags/Stream/" style="font-size: 15px;">Stream</a> <a href="/amber/tags/Java%EF%BC%8CFilter/" style="font-size: 15px;">Java，Filter</a> <a href="/amber/tags/Mybatis-plus/" style="font-size: 15px;">Mybatis-plus</a> <a href="/amber/tags/Ngrok/" style="font-size: 15px;">Ngrok</a> <a href="/amber/tags/JS/" style="font-size: 15px;">JS</a> <a href="/amber/tags/NodeJs/" style="font-size: 15px;">NodeJs</a> <a href="/amber/tags/npm/" style="font-size: 15px;">npm</a> <a href="/amber/tags/this/" style="font-size: 15px;">this</a> <a href="/amber/tags/Java-Web/" style="font-size: 15px;">Java Web</a> <a href="/amber/tags/Thymeleaf/" style="font-size: 15px;">Thymeleaf</a> <a href="/amber/tags/Encoding/" style="font-size: 15px;">Encoding</a> <a href="/amber/tags/BOM/" style="font-size: 15px;">BOM</a> <a href="/amber/tags/Unicode/" style="font-size: 15px;">Unicode</a> <a href="/amber/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/amber/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/amber/tags/openEuler/" style="font-size: 15px;">openEuler</a> <a href="/amber/tags/Java-JDK/" style="font-size: 15px;">Java, JDK</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/amber/2025/08/20/java8-24/">Java 8 到 Java 24 新特性一览</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2025/06/20/the-pragmatic-programmer/">程序员修炼之道：通向务实的最高境界（第2版）</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2025/03/20/chat2db/">Chat2DB - AI驱动的数据库管理工具</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2025/02/01/boyilun/">博弈论：每个人都能成为决策高手（《人民日报》推荐）</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/11/01/Scheduled/">解析 Spring 计划任务执行多次之谜及解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/10/01/nonviolent/">非暴力沟通</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/09/01/Reflection/">掌握 Java 反射机制</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/08/01/ApacheBench/">构造 ApacheBench 可用的 postfile</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/07/01/lambda/">Java 8 In Action Lambda</a></li><li class="post-list-item"><a class="post-list-link" href="/amber/2024/06/01/the-moon-and-sixpence/">月亮与六便士</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/amber/." rel="nofollow">Amber.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/amber/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/amber/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="150" src="//cdn.jsdelivr.net/npm/canvas-nest.js/dist/canvas-nest.min.js"></script><script type="text/javascript" src="/js/love.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/amber/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/amber/js/smartresize.js?v=1.0.0"></script></div></body></html>